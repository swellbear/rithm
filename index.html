#!/usr/bin/env node

import { build } from 'esbuild';
import { execSync } from 'child_process';

async function buildProduction() {
  try {
    // First build the frontend with Vite
    console.log('Building frontend with Vite...');
    execSync('vite build', { stdio: 'inherit' });
    
    // Then build the server with esbuild, completely excluding Vite
    console.log('Building server with esbuild...');
    
    await build({
      entryPoints: [
        'server/index.ts',
        'server/vite-production.ts', 
        'server/routes.ts',
        'server/storage.ts',
        'server/age-scheduler.ts'
      ],
      bundle: true,
      platform: 'node',
      format: 'esm',
      outdir: 'dist',
      packages: 'external', // Keep all node_modules external instead of bundling
      external: [
        // Node.js built-ins
        'crypto',
        'fs',
        'path',
        'url',
        'util',
        'buffer',
        'stream',
        'events',
        'http',
        'https',
        'zlib',
        'querystring',
        // Completely exclude Vite and development dependencies
        'vite',
        './vite',
        './vite.js'
      ],
      define: {
        'process.env.NODE_ENV': '"production"'
      },
      resolveExtensions: ['.ts', '.js'],
      loader: {
        '.ts': 'ts'
      }
    });
    
    console.log('✅ Production build completed successfully');
    
  } catch (error) {
    console.error('❌ Build failed:', error);
    process.exit(1);
  }
}

buildProduction();
